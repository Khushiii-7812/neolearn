<!DOCTYPE html>
<html>
<head>
  <title>Live Class - {{ room_name }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    #jitsi-container { width: 100%; height: 600px; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h3>ðŸŽ¥ Live Class: {{ room_name }}</h3>
    <div id="jitsi-container" class="mb-3"></div>
    <p id="participant-count">ðŸ‘¥ Participants: 0</p>

    {% if role == 'teacher' %}
    <button type="button" class="btn btn-outline-primary my-3" onclick="downloadAttendance()">ðŸ“¥ Download Attendance</button>
    {% endif %}

    {% if role == 'student' %}
    <div class="mt-4 p-3 border rounded">
      <h4>ðŸ“‹ Rate This Session</h4>
      <form method="POST" action="/feedback">
        {{ csrf_token() }}
        <input type="hidden" name="name" value="{{ user }}">
        <label for="rating">Rating (1â€“5):</label>
        <select name="rating" class="form-select my-2" required>
          <option value="">Select</option>
          {% for i in [1, 2, 3, 4, 5] %}
          <option value="{{ i }}">{{ i }}</option>
          {% endfor %}
        </select>
        <textarea name="comment" class="form-control" placeholder="Comments (optional)"></textarea>
        <button type="submit" class="btn btn-primary mt-2">Submit Feedback</button>
      </form>
    </div>
    {% endif %}
  </div>

  <script src="https://meet.jit.si/external_api.js"></script>
  <script>
    const domain = "meet.jit.si";
    const options = {
      roomName: "{{ room_name }}",
      width: "100%",
      height: 600,
      parentNode: document.querySelector('#jitsi-container'),
      userInfo: { displayName: "{{ user }}" }
    };

    const api = new JitsiMeetExternalAPI(domain, options);
    const attendance = [];

    api.addEventListener('participantJoined', (event) => {
      attendance.push({
        name: event.displayName,
        action: 'joined',
        time: new Date().toLocaleString()
      });
    });

    api.addEventListener('participantLeft', (event) => {
      attendance.push({
        name: event.displayName,
        action: 'left',
        time: new Date().toLocaleString()
      });
    });

    api.addEventListener('incomingMessage', (event) => {
      console.log(`[Chat] ${event.displayName}: ${event.message}`);
    });

    function updateParticipantCount() {
      const participants = api.getParticipantsInfo();
      const count = participants ? participants.length : 0;
      document.getElementById('participant-count').innerText = `ðŸ‘¥ Participants: ${count}`;
    }
    setInterval(updateParticipantCount, 3000);

    {% if role == 'teacher' %}
    function downloadAttendance() {
      let csv = 'Name,Action,Time\n';
      attendance.forEach(entry => {
        csv += `${entry.name},${entry.action},${entry.time}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'attendance.csv';
      link.click();
    }
    {% endif %}
  </script>
</body>
</html>
